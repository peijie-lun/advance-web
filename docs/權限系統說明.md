# 身分權限系統使用說明

## 系統架構

本系統已經實現了基於角色的權限控制（RBAC），包含以下核心功能：

### 1. AuthContext（認證上下文）
位置：`/contexts/AuthContext.tsx`

**功能：**
- 自動追蹤用戶登入狀態
- 從 Supabase profiles 表讀取用戶 role
- 提供 `useAuth()` hook 給所有頁面使用
- 管理登出功能

**使用方式：**
```tsx
import { useAuth } from '@/contexts/AuthContext';

function MyComponent() {
  const { user, role, loading, signOut } = useAuth();
  
  // user: 當前用戶物件
  // role: 用戶角色（admin 或 user）
  // loading: 認證狀態載入中
  // signOut: 登出函數
}
```

### 2. ProtectedRoute（路由保護組件）
位置：`/components/ProtectedRoute.tsx`

**功能：**
- 保護頁面，確保只有登入用戶可以訪問
- 可限定特定角色才能訪問
- 自動重定向未授權用戶

**使用方式：**
```tsx
import ProtectedRoute from '@/components/ProtectedRoute';

export default function MyPage() {
  return (
    <ProtectedRoute allowedRoles={['admin']}>
      {/* 只有 admin 可以看到這裡的內容 */}
    </ProtectedRoute>
  );
}
```

## 已實現的頁面權限

| 頁面 | 路徑 | 允許角色 | 說明 |
|------|------|----------|------|
| 首頁 | `/` | 所有人 | 根據登入狀態和角色顯示不同導航 |
| 登入 | `/login` | 未登入 | 登入頁面 |
| 註冊 | `/register` | 未登入 | 註冊頁面 |
| 訂單列表 | `/order/orderlist` | 所有登入用戶 | admin 可管理商品，user 可購買 |
| 個人資料 | `/profile` | 所有登入用戶 | 管理個人資料 |

## 角色說明

### 1. admin（管理員）
- 可訪問所有頁面
- 在訂單列表可以**新增、編輯、刪除**商品
- 擁有完整的系統管理權限

### 2. user（一般用戶）
- 可訪問訂單列表、個人資料
- 在訂單列表可以**加入購物車**購買商品
- 可查看和編輯自己的個人資料

## 資料庫設定

### profiles 表結構
```sql
CREATE TABLE profiles (
  id UUID REFERENCES auth.users PRIMARY KEY,
  email TEXT,
  username TEXT,
  full_name TEXT,
  avatar_url TEXT,
  website TEXT,
  role TEXT DEFAULT 'user', -- 只有 'user' 或 'admin'
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### 測試帳號建議
建議建立以下測試帳號：

1. **管理員帳號**
   - Email: admin@test.com
   - Role: admin

2. **一般用戶**
   - Email: user@test.com
   - Role: user

## 如何為新頁面添加權限保護

### 方法一：使用 ProtectedRoute 組件包裹
```tsx
import ProtectedRoute from '@/components/ProtectedRoute';

export default function MyPage() {
  return (
    <ProtectedRoute allowedRoles={['admin']}>
      <div>只有 admin 可以看到</div>
    </ProtectedRoute>
  );
}
```

### 方法二：在組件內使用 useAuth
```tsx
import { useAuth } from '@/contexts/AuthContext';
import { useRouter } from 'next/navigation';
import { useEffect } from 'react';

export default function MyPage() {
  const { user, role, loading } = useAuth();
  const router = useRouter();

  useEffect(() => {
    if (!loading && !user) {
      router.push('/login');
    }
    if (!loading && role !== 'admin') {
      router.push('/'); // 無權限，返回首頁
    }
  }, [user, role, loading, router]);

  if (loading) return <div>載入中...</div>;
  if (!user || role !== 'admin') return null;

  return <div>管理員專用頁面</div>;
}
```

## 首頁動態導航

首頁 (`/app/page.tsx`) 會根據用戶的角色自動顯示可訪問的頁面：

- **未登入**: 只顯示訂單列表（點擊會引導登入）
- **user**: 訂單列表、個人資料
- **admin**: 訂單列表、個人資料（在訂單列表有管理權限）

## 測試流程

1. **註冊新帳號** → 預設 role 為 'user'
2. **到 Supabase 修改 role** → 改為 'admin'（如需測試管理員功能）
3. **重新登入** → 系統會讀取新的 role
4. **檢查首頁** → 應該看到對應角色可訪問的頁面
5. **嘗試訪問限制頁面** → 應該被重定向或顯示無權限

## 進階功能

### 在組件內根據角色顯示不同內容
```tsx
import { useAuth } from '@/contexts/AuthContext';

export default function MyComponent() {
  const { role } = useAuth();

  return (
    <div>
      {role === 'admin' && <button>管理功能</button>}
      {role === 'user' && <button>購買功能</button>}
    </div>
  );
}
```

### 登出功能
```tsx
import { useAuth } from '@/contexts/AuthContext';

export default function LogoutButton() {
  const { signOut } = useAuth();

  return (
    <button onClick={signOut}>
      登出
    </button>
  );
}
```

## 常見問題

### Q: 修改 role 後沒有生效？
A: 需要重新登入，因為 role 是在登入時從資料庫讀取的。

### Q: 如何新增新的角色？
A: 目前系統只支援 user 和 admin 兩種角色。如需新增其他角色，需要：
1. 在 `profiles` 表的 role 欄位新增值
2. 在 `ProtectedRoute` 的 `allowedRoles` 中加入新角色
3. 在首頁 `getRoleBasedLinks` 函數中定義新角色可訪問的頁面

### Q: 頁面一直顯示「載入中」？
A: 檢查 AuthContext 是否正確包裹在 Providers 中，確認 Supabase 連線正常。

### Q: user 和 admin 有什麼差別？
A: 
- **user**: 只能瀏覽商品和購買，無法管理商品
- **admin**: 可以新增、編輯、刪除商品，擁有完整管理權限

## 總結

此系統提供了簡潔的二級權限控制（user 和 admin），讓不同角色的用戶可以訪問不同的功能。透過 `useAuth()` hook 和 `ProtectedRoute` 組件，可以輕鬆地為任何頁面添加權限保護。

